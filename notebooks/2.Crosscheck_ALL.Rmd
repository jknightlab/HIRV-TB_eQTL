---
title: "DNA-RNA sample crosscheck"
#author: "Ping Zhang"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    code_folding: show
params:
  SAMPLE_SHEET: "/well/jknight/users/kwz374/EQTL_OXFORD/Analysis_freeze.2024/JupyterLab/temp/1_metadata_2024_swap.corrected..xlsx"
  CrossCheckOUTPUT: "/well/jknight/users/kwz374/EQTL_OXFORD/CrosscheckFingerprints/DNA.RNA.crosscheck_Matrix_352.txt"
  CrossCheckOUTPUT2: "/well/jknight/users/kwz374/EQTL_OXFORD/CrosscheckFingerprints/DNA.RNA.crosscheck_352.txt"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 10
)

# Load parameters - this needs to be in a code chunk!
SAMPLE_SHEET <- params$SAMPLE_SHEET
CrossCheckOUTPUT <- params$CrossCheckOUTPUT
CrossCheckOUTPUT2 <- params$CrossCheckOUTPUT2

## Load Libraries and Data

```{r load_libraries}
library(pheatmap)
library(data.table)
library(RColorBrewer)
library(openxlsx)
```

```{r load_data}

# Load crosscheck matrix
data <- as.data.frame(fread(CrossCheckOUTPUT, stringsAsFactors = F))

cat("Original data dimensions:", dim(data), "\n")
cat("Number of unique READGROUPS:", length(unique(as.factor(data$READGROUP))), "\n")
```

## Data Preprocessing

```{r preprocessing}
# Remove self compare and specific columns
data = data[data$READGROUP %like% "_",]
data = data[,-which(names(data) %like% "_")]

# Load crosscheck metadata
crosscheck2 <- as.data.frame(fread(CrossCheckOUTPUT2))
crosscheck2 = crosscheck2[,c("LEFT_GROUP_VALUE","LEFT_SAMPLE" )]
crosscheck2 = crosscheck2[!duplicated(crosscheck2$LEFT_GROUP_VALUE) & !crosscheck2$LEFT_GROUP_VALUE %like% "_",]

# Load sample metadata
SAMPLE.EQTL <- read.xlsx(SAMPLE_SHEET, sheet=1)
SAMPLE.EQTL = SAMPLE.EQTL[SAMPLE.EQTL$TB_Status %in% "Latent TB",]
SAMPLE.EQTL = SAMPLE.EQTL[,c("genotype.ID_corrected","RNA.Sequencing_ID")]

# Merge and reorganize data
crosscheck3 = merge(crosscheck2, SAMPLE.EQTL, by.x="LEFT_SAMPLE",by.y="genotype.ID_corrected")
crosscheck3 = crosscheck3[order(crosscheck3$RNA.Sequencing_ID),]

data2 = data[data$READGROUP %in% crosscheck3$RNA.Sequencing_ID, c("READGROUP",crosscheck3$LEFT_GROUP_VALUE)]
names(data2)[2:ncol(data2)][match(crosscheck3$LEFT_GROUP_VALUE, names(data2[2:ncol(data2)]))] <- crosscheck3$RNA.Sequencing_ID

cat("Processed data dimensions:", dim(data2), "\n")
```

## Prepare matrix for Visualisation

```{r prepare_matrix}
# Set row names and convert to numeric matrix
row.names(data2) <- data2$READGROUP
data2 <- data2[,-1]

# Convert to numeric matrix
data2[] <- lapply(data2, function(x) as.numeric(as.character(gsub(",","",x))))

# Order columns and rows
data2 <- data2[, order(colnames(data2))]
data2 <- data2[order(rownames(data2)), ]

data_matrix <- data.matrix(data2)

# Apply thresholds for better visualization
data_matrix[data_matrix > 100] <- 100
data_matrix[data_matrix < -100] <- -100

cat("Final matrix dimensions:", dim(data_matrix), "\n")
```

## Visualize Results
### Heatmap Visualisation
```{r heatmap}
# Create heatmap with improved formatting
pheatmap(data_matrix, 
         col = colorRampPalette(brewer.pal(4, "YlGn"))(10),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         fontsize_row = 6,
         fontsize_col = 6,
         main = "DNA-RNA Crosscheck Matrix\n(TB Samples)",
         show_rownames = TRUE,
         show_colnames = TRUE)
```

### Summary Statistics

```{r summary}
# Calculate summary statistics
summary_stats <- data.frame(
  Min = min(data_matrix, na.rm = TRUE),
  Max = max(data_matrix, na.rm = TRUE),
  Mean = mean(data_matrix, na.rm = TRUE),
  Median = median(data_matrix, na.rm = TRUE),
  SD = sd(data_matrix, na.rm = TRUE)
)

print(summary_stats)

```

### Sample Overview

```{r sample_info}
cat("Number of RNA samples:", nrow(data_matrix), "\n")
cat("Number of genotype samples:", ncol(data_matrix), "\n")
cat("Sample names (first 10):\n")
print(head(rownames(data_matrix), 10))
```

## Session Information

```{r session_info}
sessionInfo()
```